# Copyright 2010 Cecil Curry <leycec@gmail.com>
# Distributed under the terms of the GNU General Public License v2

# Tomcat 5 ships a variety of "build.xml" files. The "${WORK}/build.xml"
# file delegates to "${WORK}/build/build.xml" with additional logic for
# retrieving online updates. That's bad. Thus, the latter is what we want.
require tomcat [ ant_dir="build" ]

# See the newest exheres for SLOT commentary. We maintain older Tomcat slots as
# several older Java exheres require them (for leveraging older Servlet APIs).
SLOT="5"
PLATFORMS="~amd64 ~x86"

ANT_SRC_CONFIGURE_PARAMS=( init )

# Tomcat's "build.xml" defines a "build" task building subcomponents for which
# we do not have the requisite dependencies. Don't run that. It also defines
# tasks building precisely the subcomponents we need. Run those.
ANT_SRC_COMPILE_PARAMS=( build-servletapi build-jspapi )

# The above tasks actually do too much: they compile, build javadoc, and build
# jar files. Most of these things are needed, anyway. So we're done.
ANT_SRC_INSTALL_PARAMS=( )

DEFAULT_SRC_INSTALL_EXTRA_DOCS=( "BENCHMARKS.txt" )

src_prepare() {
    tomcat_src_prepare

    # Prevent auto-generation of examples and javadoc files.
    echo ">>> Patching build.xml files"
    for TOMCAT_API_BUILD_XML in servletapi/*/build.xml; do
        edo sed -i "${TOMCAT_API_BUILD_XML}" \
            -e 's~\(depends="compile\),examples,javadoc~\1~'
    done
}

src_install() {
    antefix_src_install

    # Do this here rather via the ${JAVA_SRC_INSTALL_JARS} array as API versions
    # are not known until installation time.
    echo ">>> Installing jar files"
    javafix_install_jars \
        "${TOMCAT_DIST_ROOT_DIR}"/servlet-api-*/"lib/servlet-api.jar" \
        "${TOMCAT_DIST_ROOT_DIR}"/jsp-api-*/"lib/jsp-api.jar"

    # Other exheres requiring Tomcat 5 expect an installation tree resembling:
    #     /usr/share/tomcat/5/jsr152/dist/lib/jsp-api.jar
    #     /usr/share/tomcat/5/jsr154/dist/lib/servlet-api.jar
    echo ">>> Installing canonical symlinks"
    local TOMCAT_JAR_DIR=$(which_installed_jar_dir_for_this_exheres)
    local TOMCAT_JSP_DIR="${TOMCAT_JAR_DIR}/jsr152/dist/lib/"
    local TOMCAT_SERVLET_DIR="${TOMCAT_JAR_DIR}/jsr154/dist/lib/"
    dodir "${TOMCAT_JSP_DIR}" "${TOMCAT_SERVLET_DIR}"
    dosym "${TOMCAT_JAR_DIR}/jsp-api.jar"     "${TOMCAT_JSP_DIR}"/
    dosym "${TOMCAT_JAR_DIR}/servlet-api.jar" "${TOMCAT_SERVLET_DIR}"/
}

